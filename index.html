<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Image Generator Bot (Web版)</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* 内置一个 loading 动画 */
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      animation: spin 1s linear infinite;
      margin: 6px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #history {
      margin-top: 20px;
      padding: 10px;
      border-top: 1px solid #ccc;
    }

    .entry {
      margin-bottom: 20px;
      padding: 10px;
      border-radius: 8px;
      background: #f9f9f9;
    }

    .entry img {
      max-width: 300px;
      border-radius: 6px;
      margin-top: 10px;
      display: block;
    }

    .command {
      font-weight: bold;
      color: #2c3e50;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>🎨 Image Generator Bot</h1>
    <p>输入指令（支持: <code>!ping</code>, <code>!imagine prompt</code>）</p>
    <input id="command" type="text" placeholder="输入命令...">
    <button id="run">运行</button>
    <div id="history"></div>
  </div>

  <script>
    const runBtn = document.getElementById('run');
    const cmdInput = document.getElementById('command');
    const historyDiv = document.getElementById('history');

    function addEntry(content, isLoading = false) {
      const entry = document.createElement('div');
      entry.className = 'entry';

      if (isLoading) {
        entry.innerHTML = `
          <div class="spinner"></div>
          <p>⏳ 正在处理: <span class="command">${content}</span></p>
        `;
      } else {
        entry.innerHTML = content;
      }

      historyDiv.prepend(entry); // 新结果放在最上面
      return entry;
    }

    async function runCommand() {
      const cmd = cmdInput.value.trim();
      if (!cmd) {
        addEntry("❌ 请输入命令");
        return;
      }

      const loadingEntry = addEntry(cmd, true);

      try {
        if (cmd.startsWith('!ping')) {
          const res = await fetch('/api/ping');
          const data = await res.json();
          loadingEntry.innerHTML = `<p>✅ ${cmd} → ${data.message}</p>`;
        } else if (cmd.startsWith('!imagine')) {
          const prompt = cmd.replace('!imagine', '').trim();
          const res = await fetch('/api/imagine?prompt=' + encodeURIComponent(prompt));
          const data = await res.json();

          if (data.image) {
            loadingEntry.innerHTML = `
              <p>🖼️ <span class="command">${cmd}</span></p>
              <img src="${data.image}" alt="生成的图像">
            `;
          } else {
            loadingEntry.innerHTML = `<p>⚠️ 图像生成失败: ${data.error || "未知错误"}</p>`;
          }
        } else {
          loadingEntry.innerHTML = `<p>❌ 未知命令: <span class="command">${cmd}</span></p>`;
        }
      } catch (err) {
        console.error("前端错误:", err);
        loadingEntry.innerHTML = `<p>⚠️ 请求失败: ${err.message}</p>`;
      }
    }

    // 点击按钮执行
    runBtn.addEventListener('click', runCommand);

    // 按回车执行
    cmdInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        runCommand();
      }
    });
  </script>
</body>
</html>
